var OCRUISE=function(e){e.currentDate=function(){var a=new Date;return a.getMonth()+1+"/"+a.getDate()+"/"+a.getFullYear()};e.stdDeviation=function(a,b){function c(a,d){return a.reduce(function(a,d){return a+d},0)/d}a=function(a,d){for(var c=a.length;c<d;c++)a[c]=0;return a}(a,b);var d=c(a,b),g=a.map(function(a){a-=d;return a*a}),g=c(g,b),g=Math.sqrt(g);return g*=Math.sqrt(b/(b-1))};e.init=function(){$(document).ready(function(){window.applicationCache&&window.applicationCache.addEventListener("updateready",
function(a){window.applicationCache.status==window.applicationCache.UPDATEREADY&&confirm("A new version of OpenCruise is available. Load it now?")&&window.location.reload()},!1);"serviceWorker"in window.navigator&&(console.log("Service Workers Enabled"),window.navigator.serviceWorker.register("service-worker.js")["catch"](function(a){console.error(a)}));window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||
window.msIDBTransaction;window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;window.SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition||window.mozSpeechRecognition;if(window.openDatabase||window.indexedDB){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(a){},function(a){},{timeout:5E4,maximumAge:0,enableHighAccuracy:!0});e.defaultValues=new e.config;localStorage.defaults?e.defaultValues.load():e.defaultValues.save();
var a=e.defaultValues,b=function(){e.activeList=new e.cruiseList(a.pages.cruisePage);e.activeList.getCruises();ko.applyBindings(e.activeList,$("#cruiseListPage")[0]);ko.applyBindings(e.activeList,$("#cruisePage")[0]);ko.applyBindings(e.activeList,$("#emailPage")[0]);ko.applyBindings(e.activeList,$("#fieldsPage")[0]);ko.applyBindings(e.activeList,$("#plotPage")[0]);ko.applyBindings(e.activeList,$("#multiProductPage")[0]);ko.applyBindings(e.defaultValues,$("#configPage")[0])};e.DB=window.openDatabase?
new e.webSQL(e.webSQLConfig(),b):new e.indexedDB(e.indexedDBConfig(),b);$(".OCLoading").hide();$.mobile.initializePage();$.mobile.pageContainer.pagecontainer("change",a.pages.cruiseListPage,{});$("#cruisePage").bind("pagebeforeshow",function(){$("#selectPlotPopup ul").listview().listview("refresh");$("#cruiseName").trigger("change");$("#cruisePage").trigger("create")});$("#selectPlotPopup").on("click","li a",function(){e.activeList.selectedCruise().editPlot($(this).data("plotnum"))});$("#plotPage").bind("pagebeforeshow",
function(){$("#plotPage").trigger("create")});$("#fieldsPage").bind("pagebeforeshow",function(){$("#fieldsPage").trigger("create")});$("#multiProductPage").bind("pagebeforeshow",function(){$("#multiProductPage").trigger("create")});$("#emailPage").bind("pagebeforeshow",function(){e.activeList.selectedCruise().exportToCSV();$("#emailPage").trigger("create")})}else alert("Local Databases are not supported by your browser.")})};return e}(OCRUISE||{}),OCRUISE=function(e){e.webSQL=function(a,b){this.name=
a.name;this.version=a.version;this.tableNames=a.tables;this.initDatabase(a,b)};e.webSQL.prototype={insert:function(a,b,c){for(var d=this,g=[],f=0;f<a.length;f++){g[f]="INSERT INTO "+a[f][0]+" (";for(var h="",e="",k=0;k<a[f][1].length;k++)h=h+a[f][1][k]+", ",e+="?, ";g[f]=g[f]+h.substring(0,h.length-2)+") VALUES("+e.substring(0,e.length-2)+")"}this.DB.transaction(function(c){for(f=0;f<g.length;f++)c.executeSql(g[f],a[f][2],b,function(a,c){d.errorHandler(a,c)})},function(a,c){d.errorHandler(a,c)},c)},
select:function(a,b,c,d,g,f){var h=this,e=b;g&&(e="MAX("+b+") AS "+g);var k="SELECT "+e+" FROM "+a;if(f){var k=k+" WHERE ",m;for(m in f)k+=m+"="+f[m]+" AND ";k=k.substring(0,k.length-5)}""!=c&&(k+=" ORDER BY "+c);k+=";";this.DB.transaction(function(a){a.executeSql(k,[],d,function(a,d){h.errorHandler(a,d)})})},count:function(a,b,c,d,g){var f=this,h="SELECT COUNT("+b+") AS CNT FROM "+a;if(d){var h=h+" WHERE ",e;for(e in d)h+=e+"="+d[e]+" AND ";h=h.substring(0,h.length-5)}g&&(h+=" GROUP BY "+g);h+=";";
this.DB.transaction(function(a){a.executeSql(h,[],c,function(a,d){f.errorHandler(a,d)})})},update:function(a,b,c){var d=this,g=[],f="UPDATE "+a+" SET",h;for(h in b)f+=" "+h+"=?,",g.push(b[h]);f=f.substring(0,f.length-1);if(c){f+=" WHERE ";for(h in c)f+=h+"="+c[h]+" AND ";f=f.substring(0,f.length-5)}f+=";";this.DB.transaction(function(a){a.executeSql(f,g,d.nullDataHandler(),function(a,c){d.errorHandler(a,c)})})},deleteRows:function(a,b){for(var c=this,d=[],g=null,f=0;f<a.length;f++){d[f]="DELETE FROM "+
a[f][0];d[f]+=" WHERE ";var g=a[f][1],h;for(h in g)d[f]+=h+"="+g[h]+" AND ";d[f]=d[f].substring(0,d[f].length-5)+";"}this.DB.transaction(function(a){for(f=0;f<d.length;f++)a.executeSql(d[f],[],b,function(a,d){c.errorHandler(a,d)})})},initDatabase:function(a,b){(this.DB=openDatabase(a.name,"",a.descript,a.maxsize))?this.checkVersion(a,b):alert("Cannot open database, try installing and using a different web browser such as Chrome or Firefox.")},checkVersion:function(a,b){var c=this;""==this.DB.version?
this.DB.changeVersion("",c.version,this.createTables(a,b),function(a,b){c.errorHandler(a,b)},function(){console.log("Database initialized to version: "+c.version)}):"1.0"==this.DB.version?this.DB.changeVersion("1.0","5.0",function(a){a.executeSql("ALTER TABLE cruise ADD COLUMN mpm INTEGER ");a.executeSql('ALTER TABLE cruise ADD COLUMN field2name TEXT DEFAULT "DBH" ');a.executeSql('ALTER TABLE cruise ADD COLUMN field3name TEXT DEFAULT "Saw" ');a.executeSql('ALTER TABLE cruise ADD COLUMN field4name TEXT DEFAULT "Pulp" ');
a.executeSql("ALTER TABLE cruise ADD COLUMN field2min TEXT ");a.executeSql("ALTER TABLE cruise ADD COLUMN field2max TEXT ");a.executeSql("ALTER TABLE cruise ADD COLUMN field2init TEXT ");a.executeSql("ALTER TABLE cruise ADD COLUMN field3min TEXT ");a.executeSql("ALTER TABLE cruise ADD COLUMN field3max TEXT ");a.executeSql("ALTER TABLE cruise ADD COLUMN field3init TEXT ");a.executeSql("ALTER TABLE cruise ADD COLUMN field3field2min TEXT ");a.executeSql("ALTER TABLE cruise ADD COLUMN field4min TEXT ");
a.executeSql("ALTER TABLE cruise ADD COLUMN field4max TEXT ");a.executeSql("ALTER TABLE cruise ADD COLUMN field4init TEXT ");a.executeSql("ALTER TABLE trees ADD COLUMN seg0prod TEXT");a.executeSql("ALTER TABLE trees ADD COLUMN seg0len INTEGER");a.executeSql("ALTER TABLE trees ADD COLUMN seg1prod TEXT");a.executeSql("ALTER TABLE trees ADD COLUMN seg1len INTEGER");a.executeSql("ALTER TABLE trees ADD COLUMN seg2prod TEXT");a.executeSql("ALTER TABLE trees ADD COLUMN seg2len INTEGER");a.executeSql("ALTER TABLE trees ADD COLUMN seg3prod TEXT");
a.executeSql("ALTER TABLE trees ADD COLUMN seg3len INTEGER");a.executeSql("ALTER TABLE trees ADD COLUMN seg4prod TEXT");a.executeSql("ALTER TABLE trees ADD COLUMN seg4len INTEGER");a.executeSql("ALTER TABLE trees ADD COLUMN seg5prod TEXT");a.executeSql("ALTER TABLE trees ADD COLUMN seg5len INTEGER")},function(a,b){c.errorHandler(a,b)},function(){console.log("Database upgraded from version 1.0 to version: 5.0");b()}):(this.createTables(a,b),console.log("Database Opened, Version: "+this.DB.version))},
createTables:function(a,b){var c=this,d="";this.DB.transaction(function(b){for(var f in a.tables){d="";d+="CREATE TABLE IF NOT EXISTS "+a.tables[f].tableName+"(";for(var h in a.tables[f].fields)d+=a.tables[f].fields[h].name+" "+a.tables[f].fields[h].type+", ";d=d.substring(0,d.length-2)+");";b.executeSql(d,[],function(){c.nullDataHandler()},function(a,b){c.errorHandler(a,b)});a.tables[f].index&&(d="CREATE INDEX IF NOT EXISTS "+a.tables[f].index.name+" ON "+a.tables[f].tableName+" ("+a.tables[f].index.fields+
");",b.executeSql(d,[],function(){c.nullDataHandler()},function(a,b){c.errorHandler(a,b)}))}},function(a,b){c.errorHandler(a,b)},b)},deleteDatabase:function(){var a=this,b=[];if(confirm("All data will be erased, are you sure?")){for(var c=0;c<this.tableNames.length;c++)b[c]="DROP TABLE IF EXISTS "+this.tableNames[c].tableName+";";this.DB.transaction(function(c){for(var g=0;g<b.length;g++)c.executeSql(b[g],[],a.nullDataHandler(),function(c,b){a.errorHandler(c,b)})},function(c,b){a.errorHandler(c,b)},
function(){window.location.reload(!1)})}},nullDataHandler:function(){console.log("SQL Query Succeeded!!!")},errorHandler:function(a,b){var c="",d="";b?(c=b.message,d=b.code):a&&(c=a.message,d=a.code);console.log("Database Error: "+c+" (Code "+d+")");alert("Database Error:  "+c+" (Code "+d+") - make sure private browsing is OFF.");return!1}};e.indexedDB=function(a,b){this.name=a.name;this.version=a.version;this.initDatabase(a,b)};e.indexedDB.prototype={insert:function(a,b,c){for(var d=[],g={},f=0;f<
a.length;f++)d[f]=a[f][0];var e=this.DB.transaction(this.DB.objectStoreNames,"readwrite");e.oncomplete=function(a){c()};for(f=0;f<a.length;f++){for(var l=e.objectStore(d[f]),k=0;k<a[f][1].length;k++)g[a[f][1][k]]=a[f][2][k];l=l.add(g);g={};l.onerror=function(a){alert("IndexedDB Error.")};l.onsuccess=function(a){b(null,{insertId:a.target.result})}}},select:function(a,b,c,d,g,f){c="next";g&&(c="prev");var e={rows:{length:0,contents:[],item:function(a){return this.contents[a]}}};a=this.DB.transaction(a,
"readonly").objectStore(a);var l={indexName:a.indexNames[0],indexRange:null};f&&(l=this.buildKeyRange(f));a.index(l.indexName).openCursor(l.indexRange,c).onsuccess=function(a){if(a=a.target.result)if(e.rows.length++,e.rows.contents.push(a.value),g)e.rows.contents[0][g]=a.value[b],d("",e);else a["continue"]();else g&&(e.rows.contents[0]={},e.rows.contents[0][g]=0,e.rows.length=1),d("",e)}},count:function(a,b,c,d,g){var f=[],e={rows:{length:0,contents:[],item:function(a){return this.contents[a]}}};
a=this.DB.transaction(a,"readonly").objectStore(a);b={indexName:a.indexNames[0],indexRange:null};d&&(b=this.buildKeyRange(d));a.index(b.indexName).openCursor(b.indexRange).onsuccess=function(a){(a=a.target.result)?(e.rows.length++,e.rows.contents.push(a.value),a["continue"]()):(e.rows.contents.forEach(function(a,c){var b=a[g];"object"===typeof f[b]?f[b].CNT+=1:f[b]={CNT:1}}),f=f.filter(function(a){return void 0!=a}),e={rows:f},c("",e))}},update:function(a,b,c){for(var d in c)b[d]=c[d];this.DB.transaction(a,
"readwrite").objectStore(a).put(b).onerror=function(a){alert("IndexedDB Error - error updating cruise parameters.")}},deleteRows:function(a,b){for(var c=[],d={},g=0;g<a.length;g++)c[g]=a[g][0];var f=this.DB.transaction(c,"readwrite");f.oncomplete=function(a){b()};for(g=0;g<a.length;g++){var e=f.objectStore(c[g]),d=this.buildKeyRange(a[g][1]);e.index(d.indexName).openCursor(d.indexRange).onsuccess=function(a){if(a=a.target.result)a["delete"](),a["continue"]()}}},initDatabase:function(a,b){var c=this,
d=indexedDB.open(a.name,a.version);d.onerror=function(a){alert("IndexedDB Error - could not open database.")};d.onsuccess=function(a){c.DB=a.target.result;b();c.DB.onerror=function(a){c.errorHandler(a)}};d.onupgradeneeded=function(b){c.createTables(b,a)}},createTables:function(a,b){this.DB=a.target.result;for(var c=0;c<b.stores.length;c++)for(var d=this.DB.createObjectStore(b.stores[c].storeName,{keyPath:b.stores[c].keyPath,autoIncrement:b.stores[c].autoIncrement}),g=0;g<b.stores[c].indexes.length;g++)d.createIndex(b.stores[c].indexes[g].name,
b.stores[c].indexes[g].fields,{unique:b.stores[c].indexes[g].unique})},deleteDatabase:function(){confirm("All data will be erased, are you sure?")&&(window.indexedDB.deleteDatabase(this.name),window.location.reload(!1))},buildKeyRange:function(a){var b=[],c={indexName:"",indexRange:null},d;for(d in a)c.indexName+=d,b.push(parseInt(a[d]));c.indexRange=1==b.length?IDBKeyRange.only(b[0]):IDBKeyRange.only(b);return c},nullDataHandler:function(){console.log("IndexedDB Query Succeeded!!!")},errorHandler:function(a){console.log("IndexedDB Database Error: "+
a.target.errorCode);return!1}};return e}(OCRUISE||{}),OCRUISE=function(e){e.cruiseList=function(a){var b=e.defaultValues.cruiseParms,c=this;this.editCruisePage=a;this.cruises=ko.observableArray([]);this.selectedCruise=ko.observable(new e.cruise(0,b));this.deleteCruise=function(a){if(confirm("Delete cruise?")){var b={cruiseid:a.cruiseID};e.DB.deleteRows([["cruise",b],["plots",b],["trees",b]],function(){c.logMessage("Cruise deleted.")});c.cruises.remove(a)}};this.editCruise=function(a){c.selectedCruise(a);
$.mobile.pageContainer.pagecontainer("change",c.editCruisePage,{})}};e.cruiseList.prototype={getCruises:function(){var a=this;e.DB.select("cruise","*","",function(b,c){a.updateListPageDOM(b,c)})},newCruise:function(a,b){var c=e.defaultValues.cruiseParms;c.date=e.currentDate();e.DB.insert([["cruise","cname cpeople cdate cbaf field2name field3name field4name".split(" "),[c.jobName,c.cruisers,c.date,c.BAF,c.field2.name,c.field3.name,c.field4.name]]],function(b,g){var f=new e.cruise(g.insertId,c);a.cruises.push(f);
a.editCruise(f)},function(){a.logMessage("Cruise created.")})},deleteDatabase:function(){e.DB.deleteDatabase()},updateListPageDOM:function(a,b){var c,d,g;0==b.rows.length&&$("#welcomeToOpenCruisePopup").popup("open");for(c=0;c<b.rows.length;c++)d=b.rows.item(c),g={jobName:d.cname,date:d.cdate,cruisers:d.cpeople,BAF:d.cbaf,mpm:d.mpm,field2:{name:d.field2name,min:d.field2min,max:d.field2max,init:d.field2init},field3:{name:d.field3name,min:d.field3min,max:d.field3max,init:d.field3init,field2Min:d.field3field2min},
field4:{name:d.field4name,min:d.field4min,max:d.field4max,init:d.field4init}},this.cruises.push(new e.cruise(d.cruiseid,g))},logMessage:function(a){console.log(a)}};return e}(OCRUISE||{}),OCRUISE=function(e){e.cruise=function(a,b){var c=e.defaultValues;this.self=this;this.cruiseName=ko.observable(b.jobName);this.people=ko.observable(b.cruisers);this.BAF=ko.observable(b.BAF);this.date=ko.observable(b.date);this.multiProducts=ko.observable(!!b.mpm);this.field2={name:ko.observable(b.field2.name||c.cruiseParms.field2.name),
min:ko.observable(b.field2.min||c.cruiseParms.field2.min),max:ko.observable(b.field2.max||c.cruiseParms.field2.max),init:ko.observable(b.field2.init||c.cruiseParms.field2.init)};this.field3={name:ko.observable(b.field3.name||c.cruiseParms.field3.name),min:ko.observable(b.field3.min||c.cruiseParms.field3.min),max:ko.observable(b.field3.max||c.cruiseParms.field3.max),init:ko.observable(b.field3.init||c.cruiseParms.field3.init),field2Min:ko.observable(b.field3.field2Min||c.cruiseParms.field3.field2Min)};
this.field4={name:ko.observable(b.field4.name||c.cruiseParms.field4.name),min:ko.observable(b.field4.min||c.cruiseParms.field4.min),max:ko.observable(b.field4.max||c.cruiseParms.field4.max),init:ko.observable(b.field4.init||c.cruiseParms.field4.init)};this.selectedPlot=ko.observable();this.plots=ko.observableArray([]);this.cruiseID=a;this.defaultSpecies=c.defaultSpecies;this.numPlots=ko.observable(0);this.numTrees=ko.observable(0);this.numTreesByPlot=ko.observableArray([]);this.avgBA=ko.computed(function(){return Math.round(this.numTrees()*
this.BAF()/this.numPlots())},this);this.numPlots10Percent=ko.observable(0);this.numPlots20Percent=ko.observable(0);this.loadPlots();this.field1Values=ko.observableArray(c.speciesKey.toArray());this.showDownloadFileBtn=ko.observable(!1)};e.cruise.prototype={newPlot:function(a,b){$.mobile.loading("show",{text:"Loading",textVisible:!0,theme:"a",html:""});var c=this;e.DB.select("trees","plotnum","",function(a,b){var f,h;for(h=0;h<b.rows.length;h++)f=b.rows.item(h),f=f.MAXPLOT+1,c.selectedPlot(new e.plot("new",
c.cruiseID,f,c.defaultSpecies(),c.field2.name(),c.field3.name(),c.field4.name())),$.mobile.pageContainer.pagecontainer("change","#plotPage",{})},"MAXPLOT",{cruiseid:c.cruiseID})},updateCruise:function(a,b){var c={cname:this.cruiseName(),cpeople:this.people(),cdate:this.date(),cbaf:this.BAF(),mpm:Number(this.multiProducts()),field2name:this.field2.name(),field2min:this.field2.min(),field2max:this.field2.max(),field2init:this.field2.init(),field3name:this.field3.name(),field3min:this.field3.min(),field3max:this.field3.max(),
field3init:this.field3.init(),field3field2min:this.field3.field2Min(),field4name:this.field4.name(),field4min:this.field4.min(),field4max:this.field4.max(),field4init:this.field4.init()};e.DB.update("cruise",c,{cruiseid:this.cruiseID})},getStats:function(a,b){function c(a){var b=e.stdDeviation(d.numTreesByPlot(),d.numPlots())*d.BAF();a*=d.numTrees()*d.BAF()/d.numPlots();return Math.round(Math.pow(2*b/a,2))}var d=this,g={cruiseid:d.cruiseID},f=function(a,b){var f=0,e,g=[];for(e=0;e<b.rows.length;e++)f+=
b.rows[e].CNT,g[e]=b.rows[e].CNT;d.numTrees(f);d.numTreesByPlot(g);d.numPlots10Percent(c(.1));d.numPlots20Percent(c(.2))};e.DB.count("plots","plotnum",function(a,b){d.numPlots(b.rows[0].CNT);e.DB.count("trees","treenum",f,g,"plotnum")},g,"cruiseid");return!0},loadPlots:function(){var a=this;e.DB.select("plots","*","plotnum",function(b,c){var d,e;for(e=0;e<c.rows.length;e++)d=c.rows.item(e),a.plots.push({plotNum:d.plotnum,plotID:d.plotid})},"",{cruiseid:a.cruiseID})},editPlot:function(a){$.mobile.loading("show",
{text:"Loading",textVisible:!0,theme:"a",html:""});this.selectedPlot(new e.plot("edit",this.cruiseID,a,this.defaultSpecies(),this.field2.name(),this.field3.name(),this.field4.name()))},exportToCSV:function(){var a="",b="",c="",d=this,g={cruiseid:d.cruiseID},f=function(b,c){a=d.buildCSV(b,c);e.DB.select("cruise","*","",h,"",g)},h=function(f,g){var h=e.defaultValues;c=d.buildCSV(f,g);var h=h.field2.dbName+","+h.field3.dbName+","+h.field4.dbName,n=d.field2.name()+","+d.field3.name()+","+d.field4.name();
b=b.replace(h,n);d.csv="sep=,\r\n"+c+a+b;d.setFileDownload()};e.DB.select("trees","*","plotnum",function(a,c){b=d.buildCSV(a,c);e.DB.select("plots","*","plotnum",f,"",g)},"",g)},setFileDownload:function(){var a=!1,b;window.URL=window.URL||window.webkitURL;if(window.URL&&window.Blob){try{b=new Blob([this.csv],{type:"text/csv"})}catch(c){console.log("setFileDownload: blobs not supported")}window.URL.createObjectURL&&b?(a=window.URL.createObjectURL(b),$("#downloadFileBtn").attr("href",a),$("#downloadFileBtn").attr("download",
this.cruiseName()+".csv"),this.showDownloadFileBtn(!0),a=!0,console.log("File download supported!")):console.log("File download NOT supported.")}return a},buildCSV:function(a,b){var c="",d,e,f;if(0<b.rows.length){d=b.rows.item(b.rows.length-1);for(e in d)c+=e+",";c=c.substring(0,c.length-1);c+="\r\n"}for(e=0;e<b.rows.length;e++){d=b.rows.item(e);for(f in d)c+=d[f]+",";c=c.substring(0,c.length-1);c+="\r\n"}return c=c.replace(/null/g,"")},sendEmail:function(){/^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/.test($("#emailTo").val())?
($.mobile.loading("show",{text:"Connecting to server....",textVisible:!0,theme:"b",html:""}),$.ajax({type:"POST",url:"gmail.php",data:{data:this.csv,emailTo:$("#emailTo").val(),emailPW:$("#emailPW").val(),cruiseName:this.cruiseName},success:function(a){$.mobile.loading("hide");$("#emailSentPopup p").html("Results: "+a);$("#emailSentPopup").popup("open")},error:function(a,b,c){$.mobile.loading("hide");$("#emailSentPopup p").html("Error: "+b+" - Make sure you have a network connection.");$("#emailSentPopup").popup("open")},
dataType:"text"})):(alert("Invalid email address"),$.mobile.loading("hide"))}};return e}(OCRUISE||{}),OCRUISE=function(e){e.plot=function(a,b,c,d,g,f,h){this.field1Name=e.defaultValues.field1.name;this.field2Name=g;this.field3Name=f;this.field4Name=h;this.plotnum=c;this.trees=ko.observableArray([]);this.plotID=ko.observable(c.toString());this.cruiseid=b;this.defaultSpecies=d;this.lastEditedTree=0;this.selectedTree=ko.observable();this.showSaveButton=ko.observable(!0);this.showUpdateButton=ko.observable(!1);
this.showSpeechButton=ko.observable(!1);this.position={coords:{accuracy:null,latitude:null,longitude:null}};if(window.SpeechRecognition){var l=this;this.recognition=new SpeechRecognition;this.recognition.continuous=!0;this.recognition.ocRunning=!1;this.recognition.ocSpeciesGrammar=this.buildSpeciesGrammar(e.defaultValues.speciesKey.species());this.recognition.onresult=function(a){l.speechInputResult(a)};this.recognition.onstart=function(){l.trees()[l.lastEditedTree].field1Focus(!0)};this.recognition.onend=
function(){l.recognition.ocRunning&&l.recognition.start()};this.showSpeechButton(!0)}"new"==a?this.initPlot():this.loadPlot()};e.plot.prototype={initPlot:function(){var a;for(a=0;10>a;a++)this.trees.push(new e.tree(this.defaultSpecies,null,null,null,[]));this.updatePosition();this.showSaveButton(!0);this.showUpdateButton(!1)},addTree:function(){this.trees.push(new e.tree(this.defaultSpecies,null,null,null,[]));$("#plotDetail").trigger("create")},loadPlot:function(){var a=this,b=e.defaultValues;this.showSaveButton(!1);
this.showUpdateButton(!0);var c={cruiseid:this.cruiseid,plotnum:this.plotnum},d=function(c,d){var h,l,k,m;for(h=0;h<d.rows.length;h++){k=d.rows.item(h);m=[];for(l=0;6>l;l++)m.push({product:k["seg"+l+"prod"],length:k["seg"+l+"len"]});a.trees.push(new e.tree(k[b.field1.dbName],k[b.field2.dbName],k[b.field3.dbName],k[b.field4.dbName],m));a.lastEditedTree++}k&&a.plotID(k.plotid);$.mobile.pageContainer.pagecontainer("change",b.pages.plotPage,{})};e.DB.select("plots","*","",function(b,f){a.position={coords:{accuracy:null,
latitude:null,longitude:null}};if(0<f.rows.length){var h=f.rows.item(0);a.plotID(h.plotid);a.position={coords:{accuracy:h.accuracy,latitude:h.latitude,longitude:h.longitude}}}e.DB.select("trees","*","",d,"",c)},"",c)},updatePosition:function(){var a=this;navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(b){a.position=b},function(a){console.log("plot.updatePosition - unable to get current position.")},{timeout:5E4,maximumAge:0,enableHighAccuracy:!0})},speechInputToggle:function(a,
b){var c=b.target;this.recognition.ocRunning?(this.recognition.ocRunning=!1,$(c).css("background-color","#088A08"),this.recognition.stop(c)):(this.recognition.ocRunning=!0,this.recognition.start(c),$(c).css("background-color","#FF0000"))},speechInputResult:function(a){if(this.recognition.ocRunning){var b=e.defaultValues,c=this.trees(),d=$(":focus").attr("id"),g=parseInt(d.substr(4,d.indexOf("field")-4),10),d=d.substr(d.indexOf("field"));if((a=a.results[a.resultIndex][0].transcript.replace(/porn/gi,
"4").replace(/for/gi,"4").replace(/to/gi,"2").replace(/att/gi,"8").replace(/ate/gi,"8").replace(/sex/gi,"6"))&&d)switch(d){case "field1":a=this.getDistanceFromArray(a.toLowerCase(),this.recognition.ocSpeciesGrammar,10);if(b=b.speciesKey.getKey(a))c[g].field1(b),c[g].field2Focus(!0);break;case "field2":c[g].field2(a.replace(/\s+/g,""));c[g].field3Focus(!0);break;case "field3":c[g].field3(a.replace(/\s+/g,""));c[g].field4Focus(!0);break;case "field4":c[g].field4(a.replace(/\s+/g,"")),this.lastEditedTree++,
c[g+1].field1Focus(!0)}$("#plotDetail select").selectmenu("refresh")}},buildSpeciesGrammar:function(a){var b,c,d=[];for(b=0;b<a.length;b++)for(c=0;c<a[b].names.length;c++)d.push(a[b].names[c]);return d},getDistanceFromArray:function(a,b,c){for(var d=[],e=b.length;e--;)d[e]=this.levenshteinDistance(b[e],a);a=Math.min.apply(Math,d);return a<=c?b[d.indexOf(a)]:null},levenshteinDistance:function(a,b){var c=[],d=a.length,e=b.length;if(0===d)return e;if(0===e)return d;for(var f=d;0<=f;f--)c[f]=[];for(f=
d;0<=f;f--)c[f][0]=f;for(var h=e;0<=h;h--)c[0][h]=h;for(f=1;f<=d;f++)for(var l=a.charAt(f-1),h=1;h<=e;h++){if(f===h&&4<c[f][h])return d;var k=b.charAt(h-1),m=l===k?0:1,n=c[f-1][h]+1,p=c[f][h-1]+1,q=c[f-1][h-1]+m;p<n&&(n=p);q<n&&(n=q);c[f][h]=n;1<f&&1<h&&l===b.charAt(h-2)&&a.charAt(f-2)===k&&(c[f][h]=Math.min(c[f][h],c[f-2][h-2]+m))}return c[d][e]},insertPlot:function(a){this.recognition&&(this.recognition.ocRunning=!1);var b=e.defaultValues,c=this,d=this.trees(),g=[],f=this.position,h="cruiseid plotid plotnum comments covertype accuracy latitude longitude deleted".split(" ");
g.push(["plots",h,[this.cruiseid,this.plotID(),this.plotnum,"","",f.coords.accuracy,f.coords.latitude,f.coords.longitude,0]]);h=["cruiseid","plotid","plotnum","treenum",b.field1.dbName,b.field2.dbName,b.field3.dbName,b.field4.dbName,"deleted","seg0prod","seg0len","seg1prod","seg1len","seg2prod","seg2len","seg3prod","seg3len","seg4prod","seg4len","seg5prod","seg5len"];for(b=0;b<d.length;b++)0<d[b].field2()&&g.push(["trees",h,[this.cruiseid,this.plotID(),this.plotnum,b,d[b].field1(),d[b].field2(),d[b].field3(),
d[b].field4(),0,d[b].segments[0].product(),d[b].segments[0].length(),d[b].segments[1].product(),d[b].segments[1].length(),d[b].segments[2].product(),d[b].segments[2].length(),d[b].segments[3].product(),d[b].segments[3].length(),d[b].segments[4].product(),d[b].segments[4].length(),d[b].segments[5].product(),d[b].segments[5].length()]]);e.DB.insert(g,function(){return!0},function(){a&&(a.plots.push({plotNum:c.plotnum,plotID:c.plotID()}),c.logMessage("Plot added."));$.mobile.pageContainer.pagecontainer("change",
"#cruisePage",{})})},updatePlot:function(a){var b=this,c={cruiseid:this.cruiseid,plotnum:this.plotnum};e.DB.deleteRows([["plots",c],["trees",c]],function(){a.plots.remove(function(a){return a.plotNum==b.plotnum})});this.insertPlot(a)},multiProductEntry:function(a,b){this.selectedTree(a);$.mobile.pageContainer.pagecontainer("change","#multiProductPage",{})},logMessage:function(a){console.log(a)}};return e}(OCRUISE||{}),OCRUISE=function(e){e.tree=function(a,b,c,d,g){var f=e.defaultValues,h=f.speciesKey.toArray();
-1==h.indexOf(a)&&h.push(a);this.field1=ko.observable(a);this.field2=ko.observable(b);this.field3=ko.observable(c);this.field4=ko.observable(d);this.field1Focus=ko.observable(!1);this.field2Focus=ko.observable(!1);this.field3Focus=ko.observable(!1);this.field4Focus=ko.observable(!1);this.segments=[];this.grades=ko.observableArray(f.gradeKey.toArray());this.field1Values=ko.observableArray(h);for(a=0;6>a;a++)g[a]?(this.segments.push({id:a,product:ko.observable(g[a].product),length:ko.observable(g[a].length)}),
-1==this.grades.indexOf(g[a].product)&&this.grades.push(g[a].product)):this.segments.push({id:a,product:ko.observable(" "),length:ko.observable(null)})};e.tree.prototype={validateTree:function(a,b){var c=e.activeList.selectedCruise(),d=b.target,g=Number(d.value);-1<d.id.indexOf("field2")&&(g<c.field2.min()||g>c.field2.max())?$(d).parent().css("background-color","#FF0000"):-1<d.id.indexOf("field3")&&0<g&&Number(a.field2())<c.field3.field2Min()?$(d).parent().css("background-color","#FF0000"):-1<d.id.indexOf("field3")&&
(g<c.field3.min()||g>c.field3.max())?$(d).parent().css("background-color","#FF0000"):-1<d.id.indexOf("field4")&&(g<c.field4.min()||g>c.field4.max())?$(d).parent().css("background-color","#FF0000"):$(d).parent().css("background-color","#088A08")}};return e}(OCRUISE||{}),OCRUISE=function(e){e.config=function(){this.cruiseParms={jobName:"New Cruise",cruisers:"Jim Rivard",date:e.currentDate(),BAF:"10",mpm:!1,field2:{name:"DBH",min:"5",max:"62",init:""},field3:{name:"Saw",min:"0",max:"10",init:"",field2Min:11},
field4:{name:"Pulp",min:"0",max:"12",init:""}};this.speciesKey={species:ko.observableArray([{key:"HM",names:["hard maple","sugar maple"]},{key:"RM",names:["red maple","soft maple"]},{key:"AS",names:["aspen"]},{key:"RO",names:["red oak"]},{key:"BF",names:["balsam fir"]},{key:"YB",names:["yellow birch"]},{key:"PB",names:["paper birch","white birch"]},{key:"BW",names:["basswood"]},{key:"WA",names:["white ash"]},{key:"BA",names:["black ash"]},{key:"BC",names:["black cherry"]},{key:"BP",names:["balsam poplar"]},
{key:"WP",names:["white pine"]},{key:"RP",names:["red pine"]},{key:"JP",names:["jack pine"]},{key:"WS",names:["white spruce"]},{key:"BS",names:["black spruce"]},{key:"TM",names:["tamarack"]},{key:"WC",names:["white cedar","cedar"]},{key:"EH",names:["hemlock"]},{key:"AE",names:["elm"]},{key:"IW",names:["ironwood"]},{key:"MA",names:["mountain ash"]},{key:"SNAG",names:["snag"]}])};this.defaultSpecies=ko.observable("HM");this.field1={name:"Species",dbName:"species"};this.field2={dbName:"dbh"};this.field3=
{dbName:"sawlogs"};this.field4={dbName:"pulpsticks"};this.gradeKey={grades:ko.observableArray([{key:"1"},{key:"2"},{key:"3"},{key:"Bolt"},{key:"V"},{key:"C"},{key:"Pulp"}])};this.BAF=[10,20,40,80];this.pages={cruiseListPage:"#cruiseListPage",cruisePage:"#cruisePage",plotPage:"#plotPage"};this.speciesKey.deleteSpecies=function(a,b){this.species.remove(a)};this.speciesKey.addSpecies=function(a,b){this.species.unshift({key:"new",names:[]});$("#configPage").trigger("create")};this.speciesKey.getKey=function(a){for(var b=
0;b<this.species().length;b++)for(var c=0;c<this.species()[b].names.length;c++)if(this.species()[b].names[c]==a)return this.species()[b].key;return null};this.speciesKey.toArray=function(){for(var a=[],b=0;b<this.species().length;b++)a.push(this.species()[b].key);return a};this.gradeKey.toArray=function(){for(var a=[],b=0;b<this.grades().length;b++)a.push(this.grades()[b].key);return a};this.gradeKey.deleteGrade=function(a,b){this.grades.remove(a)};this.gradeKey.addGrade=function(a,b){this.grades.unshift({key:"new"});
$("#configPage").trigger("create")};this.save=function(a,b){a&&(a.max&&(a.max=parseInt(a.max,10)),a.min&&(a.min=parseInt(a.min,10)));localStorage.defaults=ko.toJSON(this)};this.load=function(){var a=JSON.parse(localStorage.defaults);this.speciesKey.species(a.speciesKey.species);a.cruiseParms&&(this.cruiseParms=a.cruiseParms);a.gradeKey&&this.gradeKey.grades(a.gradeKey.grades);this.defaultSpecies(a.defaultSpecies)}};e.webSQLConfig=function(){var a=e.defaultValues;return{name:"CRUISEDB",version:"5.0",
descript:"CRUISE DB",maxsize:2E5,tables:[{tableName:"cruise",fields:[{name:"cruiseid",type:"INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT"},{name:"cname",type:"TEXT NOT NULL"},{name:"cpeople",type:"TEXT NOT NULL"},{name:"cdate",type:"TEXT"},{name:"cbaf",type:"TEXT"},{name:"mpm",type:"INTEGER"},{name:"field2name",type:'TEXT DEFAULT "DBH"'},{name:"field3name",type:'TEXT DEFAULT "Saw"'},{name:"field4name",type:'TEXT DEFAULT "Pulp"'},{name:"field2min",type:"TEXT"},{name:"field2max",type:"TEXT"},{name:"field2init",
type:"TEXT"},{name:"field3min",type:"TEXT"},{name:"field3max",type:"TEXT"},{name:"field3init",type:"TEXT"},{name:"field3field2min",type:"TEXT"},{name:"field4min",type:"TEXT"},{name:"field4max",type:"TEXT"},{name:"field4init",type:"TEXT"}]},{tableName:"plots",index:{name:"cruiseid_idx",fields:"cruiseid"},fields:[{name:"id",type:"INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT"},{name:"cruiseid",type:"INTEGER NOT NULL"},{name:"plotnum",type:"INTEGER NOT NULL"},{name:"plotid",type:"TEXT NOT NULL"},{name:"comments",
type:"TEXT"},{name:"covertype",type:"TEXT"},{name:"accuracy",type:"INTEGER"},{name:"latitude",type:"REAL"},{name:"longitude",type:"REAL"},{name:"deleted",type:"INTEGER"}]},{tableName:"trees",index:{name:"cruiseid_plotnum_idx",fields:"cruiseid, plotnum"},fields:[{name:"treeid",type:"INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT"},{name:"cruiseid",type:"INTEGER NOT NULL"},{name:"plotnum",type:"INTEGER NOT NULL"},{name:"plotid",type:"TEXT NOT NULL"},{name:"treenum",type:"INTEGER"},{name:a.field1.dbName,
type:"TEXT NOT NULL"},{name:a.field2.dbName,type:"INTEGER NOT NULL"},{name:a.field3.dbName,type:"INTEGER"},{name:a.field4.dbName,type:"INTEGER"},{name:"deleted",type:"INTEGER"},{name:"seg0prod",type:"TEXT"},{name:"seg0len",type:"INTEGER"},{name:"seg1prod",type:"TEXT"},{name:"seg1len",type:"INTEGER"},{name:"seg2prod",type:"TEXT"},{name:"seg2len",type:"INTEGER"},{name:"seg3prod",type:"TEXT"},{name:"seg3len",type:"INTEGER"},{name:"seg4prod",type:"TEXT"},{name:"seg4len",type:"INTEGER"},{name:"seg5prod",
type:"TEXT"},{name:"seg5len",type:"INTEGER"}]}]}};e.indexedDBConfig=function(){return{name:"CRUISEDB",version:2,stores:[{storeName:"cruise",keyPath:"cruiseid",autoIncrement:!0,indexes:[{name:"cruiseid",fields:"cruiseid",unique:!0}]},{storeName:"plots",keyPath:["cruiseid","plotnum"],autoIncrement:!1,indexes:[{name:"cruiseid",fields:"cruiseid",unique:!1},{name:"cruiseidplotnum",fields:["cruiseid","plotnum"],unique:!0}]},{storeName:"trees",keyPath:["cruiseid","plotnum","treenum"],autoIncrement:!1,indexes:[{name:"cruiseid",
fields:"cruiseid",unique:!1},{name:"cruiseidplotnum",fields:["cruiseid","plotnum"],unique:!1}]}]}};return e}(OCRUISE||{});